import os
import html
import datetime
import urllib.parse
import gradio as gr
from PIL import Image
import shutil
import json
import csv
import re
from modules import scripts, shared,script_callbacks
from scripts import promptgen as PG
from scripts import superprompt as SP

extension_path = scripts.basedir()
refresh_symbol = '\U0001f504'  # ğŸ”„
close_symbol = '\U0000274C'  # âŒ
save_symbol = '\U0001F4BE' #ğŸ’¾
delete_style = '\U0001F5D1' #ğŸ—‘ï¸
clear_symbol = '\U0001F9F9' #ğŸ§¹

card_size_value = 0
card_size_min = 0
card_size_max = 0
favourites = []
hideoldstyles = False
config_json = os.path.join(extension_path,"scripts" ,"config.json")

def save_card_def(value):
    global card_size_value
    save_settings("card_size",value)
    card_size_value = value
    
if not os.path.exists(config_json):
    default_config = {
        "card_size": 118,
        "card_size_min": 50,
        "card_size_max": 200,
        "autoconvert": True,
        "hide_old_styles": False,
        "favourites": []
    }
    
    with open(config_json, 'w') as config_file:
        json.dump(default_config, config_file, indent=4)

# Load values from the JSON file
with open(config_json, "r") as json_file:
    data = json.load(json_file)
    card_size_value = data["card_size"]
    card_size_min = data["card_size_min"]
    card_size_max = data["card_size_max"]
    autoconvert = data["autoconvert"]
    favourites = data["favourites"]
    hide_old_styles = data["hide_old_styles"]

def reload_favourites():
    with open(config_json, "r") as json_file:
        data = json.load(json_file)
        global favourites
        favourites = data["favourites"]

def save_settings(setting,value):
    with open(config_json, "r") as json_file:
        data = json.load(json_file)
    data[setting] = value
    with open(config_json, "w") as json_file:
        json.dump(data, json_file, indent=4)

def img_to_thumbnail(img):
    return gr.update(value=img)

character_translation_table = str.maketrans('"*/:<>?\\|\t\n\v\f\r', 'ï¼‚ï¼Šï¼ï¼šï¼œï¼ï¼Ÿï¼¼ï¿¨     ')
leading_space_or_dot_pattern = re.compile(r'^[\s.]')


def replace_illegal_filename_characters(input_filename: str):
    r"""
    Replace illegal characters with full-width variant
    if leading space or dot then add underscore prefix
    if input is blank then return underscore
    Table
    "           ->  uff02 full-width quotation mark         ï¼‚
    *           ->  uff0a full-width asterisk               ï¼Š
    /           ->  uff0f full-width solidus                ï¼
    :           ->  uff1a full-width colon                  ï¼š
    <           ->  uff1c full-width less-than sign         ï¼œ
    >           ->  uff1e full-width greater-than sign      ï¼
    ?           ->  uff1f full-width question mark          ï¼Ÿ
    \           ->  uff3c full-width reverse solidus        ï¼¼
    |           ->  uffe8 half-width forms light vertical   ï¿¨
    \t\n\v\f\r  ->  u0020 space
    """
    if input_filename:
        output_filename = input_filename.translate(character_translation_table)
        # if  leading character is a space or a dot, add _ in front
        return '_' + output_filename if re.match(leading_space_or_dot_pattern, output_filename) else output_filename
    return '_'  # if input is None or blank


def create_json_objects_from_csv(csv_file):
    json_objects = []
    with open(csv_file, 'r', newline='', encoding='utf-8-sig') as csvfile:
        reader = csv.DictReader(csvfile)
        for row in reader:
            # Retrieve values from CSV with special character handling
            name = row.get('name', None)
            prompt = row.get('prompt', None)
            negative_prompt = row.get('negative_prompt', None)
            if name is None or prompt is None or negative_prompt is None:
                print("Warning: Skipping row with missing values.")
                continue
            safe_name = replace_illegal_filename_characters(name)
            json_data = {
                "name": safe_name,
                "description": "converted from csv",
                "preview": f"{safe_name}.jpg",
                "prompt": prompt,
                "negative": negative_prompt,
            }
            json_objects.append(json_data)
    return json_objects

def save_json_objects(json_objects):
    if not json_objects:
        print("Warning: No JSON objects to save.")
        return

    styles_dir = os.path.join(extension_path, "styles")
    csv_conversion_dir = os.path.join(styles_dir, "CSVConversion")
    os.makedirs(csv_conversion_dir, exist_ok=True)

    nopreview_image_path = os.path.join(extension_path, "nopreview.jpg")
    for json_obj in json_objects:
        try:
            json_file_path = os.path.join(csv_conversion_dir, f"{json_obj['name']}.json")
            with open(json_file_path, 'w') as jsonfile:
                json.dump(json_obj, jsonfile, indent=4)
            image_path = os.path.join(csv_conversion_dir, f"{json_obj['name']}.jpg")
            shutil.copy(nopreview_image_path, image_path)
        except Exception as e:
            print(f'{e}\nStylez Failed to convert {json_obj.get("name", str(json_obj))}')

        
if autoconvert:
    styles_files = shared.cmd_opts.styles_file if isinstance(shared.cmd_opts.styles_file, list) else [shared.cmd_opts.styles_file]
    for styles_file_path in styles_files:
        if os.path.exists(styles_file_path):
            json_objects = create_json_objects_from_csv(styles_file_path)
            save_json_objects(json_objects)
        else:
            print(f"File does not exist: {styles_file_path}")  # Optional: log or handle the case where a file doesn't exist

    save_settings("autoconvert", False)


def generate_html_code():
    reload_favourites()
    style = None
    style_html = ""
    categories_list = ["All","Favourites"]
    save_categories_list =[]
    styles_dir = os.path.join(extension_path, "styles")
    current_time = datetime.datetime.now()
    formatted_time = current_time.strftime('%H:%M:%S.%f')
    formatted_time = formatted_time.replace(":", "")
    formatted_time = formatted_time.replace(".", "")
    try:
        for root, dirs, _ in os.walk(styles_dir):
            for directory in dirs:
                subfolder_name = os.path.basename(os.path.join(root, directory))
                if subfolder_name.lower() not in categories_list:
                    categories_list.append(subfolder_name)
                if subfolder_name.lower() not in save_categories_list:
                    save_categories_list.append(subfolder_name)    
        for root, _, files in os.walk(styles_dir):
            for filename in files:
                if filename.endswith(".json"):
                    json_file_path = os.path.join(root, filename)
                    subfolder_name = os.path.basename(root)
                    with open(json_file_path, "r", encoding="utf-8") as f:
                        try:
                            style = json.load(f)
                            title = style.get("name", "")
                            preview_image = style.get("preview", "")
                            description = style.get("description", "")
                            img = os.path.join(os.path.dirname(json_file_path), preview_image)
                            img = os.path.abspath(img)
                            prompt = style.get("prompt", "")
                            prompt = html.escape(json.dumps(prompt))
                            prompt_negative = style.get("negative", "")
                            prompt_negative =html.escape(json.dumps(prompt_negative))
                            imghack = img.replace("\\", "/")
                            json_file_path = json_file_path.replace("\\", "/")
                            encoded_filename = urllib.parse.quote(filename, safe="")
                            titlelower = str(title).lower()
                            color = ""
                            stylefavname =subfolder_name + "/" + filename
                            if (stylefavname in favourites):
                                color = "#EBD617"
                            else:
                                color = "#ffffff"
                            style_html += f"""
                            <div class="style_card" data-category='{subfolder_name}' data-title='{titlelower}' style="min-height:{card_size_value}px;max-height:{card_size_value}px;min-width:{card_size_value}px;max-width:{card_size_value}px;">
                                <div class="style_card_checkbox" onclick="toggleCardSelection(event, '{subfolder_name}','{encoded_filename}')">â—‰</div>  <!-- è¿™é‡Œæ·»åŠ å‹¾é€‰æ¡† -->
                                <img class="styles_thumbnail" src="{"file=" + img +"?timestamp"+ formatted_time}" alt="{title} Preview">
                                <div class="EditStyleJson">
                                    <button onclick="editStyle(`{title}`,`{imghack}`,`{description}`,`{prompt}`,`{prompt_negative}`,`{subfolder_name}`,`{encoded_filename}`,`Stylez`)">ğŸ–‰</button>
                                </div>
                                <div class="favouriteStyleJson">
                                    <button class="favouriteStyleBtn" style="color:{color};" onclick="addFavourite('{subfolder_name}','{encoded_filename}', this)">â˜…</button>
                                </div>
                                    <div onclick="applyStyle(`{prompt}`,`{prompt_negative}`,`Stylez`)" onmouseenter="event.stopPropagation(); hoverPreviewStyle(`{prompt}`,`{prompt_negative}`,`Stylez`)" onmouseleave="hoverPreviewStyleOut()" class="styles_overlay"></div>
                                    <div class="styles_title">{title}</div>
                                    <p class="styles_description">{description}</p>
                                </img>
                            </div>
                            """
                        except json.JSONDecodeError:
                            print(f"Error parsing JSON in file: {filename}")
                        except KeyError as e:
                            print(f"KeyError: {e} in file: {filename}")
    except FileNotFoundError:
        print("Directory '/models/styles' not found.")
    return style_html, categories_list, save_categories_list

def refresh_styles(cat):
    if cat is None or len(cat) == 0 or cat  == "[]" :
        cat = None
    newhtml = generate_html_code()
    newhtml_sendback = newhtml[0]
    newcat_sendback = newhtml[1]
    newfilecat_sendback = newhtml[2]
    return newhtml_sendback,gr.update(choices=newcat_sendback),gr.update(value="All"),gr.update(choices=newfilecat_sendback)

def save_style(title, img, description, prompt, prompt_negative, filename, save_folder):
    print(f"""Saved: '{save_folder}/{filename}'""")
    if save_folder and filename:
        if img is None or img == "":
            img = Image.open(os.path.join(extension_path, "nopreview.jpg")) 
        img = img.resize((200, 200))
        save_folder_path = os.path.join(extension_path, "styles", save_folder)
        if not os.path.exists(save_folder_path):
            os.makedirs(save_folder_path)
        json_data = {
            "name": title,
            "description": description,
            "preview": filename + ".jpg",
            "prompt": prompt,
            "negative": prompt_negative,
        }
        json_file_path = os.path.join(save_folder_path, filename + ".json")
        with open(json_file_path, "w") as json_file:
            json.dump(json_data, json_file, indent=4)
        img_path = os.path.join(save_folder_path, filename + ".jpg")
        img.save(img_path)
        msg = f"""File Saved to '{save_folder}'"""
        info(msg)
    else:
        msg = """Please provide a valid save folder and Filename"""
        warning(msg)
    return filename_check(save_folder,filename)

def info(message):
    gr.Info(message)

def warning(message):
    gr.Warning(message)
    
def tempfolderbox(dropdown):
    return gr.update(value=dropdown)

def filename_check(folder,filename):
    if filename is None or len(filename) == 0 :
        warning = """<p id="style_filename_check" style="color:orange;">è¯·è¾“å…¥æ–‡ä»¶åï¼ï¼ï¼</p>"""
    else:
        save_folder_path = os.path.join(extension_path, "styles", folder)
        json_file_path = os.path.join(save_folder_path, filename + ".json")
        if os.path.exists(json_file_path):
            warning = f"""<p id="style_filename_check" style="color:green;">æ–‡ä»¶å·²æ·»åŠ åˆ° '{folder}'</p>"""
        else:
            warning = """<p id="style_filename_check" style="color:green;">æ–‡ä»¶åæœ‰æ•ˆï¼ï¼ï¼</p>"""
    return gr.update(value=warning)

def clear_style():
    previewimage = os.path.join(extension_path, "nopreview.jpg")
    return gr.update(value=None),gr.update(value=previewimage),gr.update(value=None),gr.update(value=None),gr.update(value=None),gr.update(value=None),gr.update(value=None)

def deletestyle(folder, filename):
    base_path = os.path.join(extension_path, "styles", folder)
    json_file_path = os.path.join(base_path, filename + ".json")
    jpg_file_path = os.path.join(base_path, filename + ".jpg")

    if os.path.exists(json_file_path):
        os.remove(json_file_path)
        warning(f"""Stlye "{filename}" deleted!! """)
        if os.path.exists(jpg_file_path):
            os.remove(jpg_file_path)
        else:
            warning(f"Error: {jpg_file_path} not found.")
    else:
        warning(f"Error: {json_file_path} not found.")

def addToFavourite(style):
 global favourites
 if (style not in favourites):
     favourites.append(style)
     save_settings("favourites",favourites)
     info("style added to favourites")

def removeFavourite(style):
 global favourites
 if (style in favourites):
     favourites.remove(style)
     save_settings("favourites",favourites)
     info("style removed from favourites")

def oldstyles(value):
    with open(config_json, "r") as json_file:
        data = json.load(json_file)
        if (data["hide_old_styles"] == True):
            save_settings("hide_old_styles",False)
        else:
            save_settings("hide_old_styles",True)

def generate_style(prompt,temperature,top_k,max_length,repitition_penalty,usecomma):
    result = PG.generate(prompt,temperature,top_k,max_length,repitition_penalty,usecomma)
    return gr.update(value=result)

def call_generate_super_prompt(prompt,superprompt_max_length):
    return SP.generate_super_prompt(prompt,max_new_tokens=superprompt_max_length)

def add_tab():
    generate_styles_and_tags = generate_html_code()
    nopreview = os.path.join(extension_path, "nopreview.jpg")
    global hideoldstyles
    with gr.Blocks(analytics_enabled=False,) as ui:
        with gr.Tabs(elem_id = "Stylez"): 
            gr.HTML("""<div id="stylezPreviewBoxid" class="stylezPreviewBox"><p id="stylezPreviewPositive">test</p><p id="stylezPreviewNegative">test</p></div>""")
            #with gr.TabItem(label="é£æ ¼",elem_id="styles_libary"):
            #    with gr.Column():
            #        with gr.Column():
            #            with gr.Tabs(elem_id = "libs"):

            with gr.TabItem(label="é£æ ¼åº“"):
                with gr.Row():                      
                    with gr.Column(elem_id="style_quicklist_column"):
                        with gr.Row():
                            gr.Text("å¿«é€Ÿä¿å­˜æç¤ºè¯",show_label=False)
                            with gr.Row():
                                stylezquicksave_add = gr.Button("æ·»åŠ " ,elem_classes="stylezquicksave_add")
                                stylezquicksave_clear = gr.Button("æ¸…é™¤" ,elem_classes="stylezquicksave_add")
                        with gr.Row(elem_id="style_cards_row"):                        
                                gr.HTML("""<ul id="styles_quicksave_list"></ul>""")
                    with gr.Column():
                        with gr.Row(elem_id="style_search_search"):
                            Style_Search = gr.Textbox('', label="æœç´¢æ¡†", elem_id="style_search", placeholder="æœç´¢...", elem_classes="textbox", lines=1,scale=3)
                            category_dropdown = gr.Dropdown(label="é£æ ¼å¤§ç±»", choices=generate_styles_and_tags[1], value="All", lines=1, elem_id="style_Catagory", elem_classes="dropdown styles_dropdown",scale=1)
                            refresh_button = gr.Button(refresh_symbol, label="Refresh", elem_id="style_refresh", elem_classes="tool", lines=1)
                        with gr.Row():
                            with gr.Column(elem_id="style_cards_column"):
                                Styles_html=gr.HTML(generate_styles_and_tags[0])
                with gr.Row(elem_id="stylesPreviewRow"):
                    gr.Checkbox(value=True,label="åº”ç”¨/ç§»é™¤æ­£å‘è¯", elem_id="styles_apply_prompt", elem_classes="styles_checkbox checkbox", lines=1)
                    gr.Checkbox(value=True,label="åº”ç”¨/ç§»é™¤è´Ÿå‘è¯", elem_id="styles_apply_neg", elem_classes="styles_checkbox checkbox", lines=1)
                    gr.Checkbox(value=True,label="æ‚¬åœé¢„è§ˆ", elem_id="HoverOverStyle_preview", elem_classes="styles_checkbox checkbox", lines=1)
                    oldstylesCB = gr.Checkbox(value=hideoldstyles,label="éšè—åŸå§‹æ ·å¼æ ", elem_id="hide_default_styles", elem_classes="styles_checkbox checkbox", lines=1,interactive=True)
                    setattr(oldstylesCB,"do_not_save_to_config",True)
                    card_size_slider = gr.Slider(value=card_size_value,minimum=card_size_min,maximum=card_size_max,label="é¢„è§ˆå°ºå¯¸:", elem_id="card_thumb_size")
                    setattr(card_size_slider,"do_not_save_to_config",True)
                with gr.Row(elem_id="stylesPreviewRow"):
                    favourite_temp = gr.Text(elem_id="favouriteTempTxt",interactive=False,label="Positive:",lines=2,visible=False)
                    add_favourite_btn = gr.Button(elem_id="stylezAddFavourite",visible=False)
                    remove_favourite_btn = gr.Button(elem_id="stylezRemoveFavourite",visible=False)

            #with gr.TabItem(label="Cç«™çƒ­è¯"):
            #    with gr.Row():
            #        with gr.Column(elem_id="civit_tags_column"):
            #            nsfwlvl = gr.Dropdown(label="NSFW:", choices=["None", "Soft", "Mature", "X"], value="None", lines=1, elem_id="civit_nsfwfilter", elem_classes="dropdown styles_dropdown",scale=1)
            #            sortcivit  = gr.Dropdown(label="åˆ†ç±»:", choices=["Most Reactions", "Most Comments", "Newest"], value="Most Reactions", lines=1, elem_id="civit_sortfilter", elem_classes="dropdown styles_dropdown",scale=1)
            #            periodcivit  = gr.Dropdown(label="æ—¶é—´æ®µ:", choices=["AllTime", "Year", "Month", "Week", "Day"], value="AllTime", lines=1, elem_id="civit_periodfilter", elem_classes="dropdown styles_dropdown",scale=1)
            #        with gr.Column():
            #            with gr.Row(elem_id="style_search_search"):
            #                fdg = gr.Textbox('', label="æœç´¢æ¡†", elem_id="style_search", placeholder="ä¸èµ·ä½œç”¨ï¼APIä¸æ”¯æŒï¼", elem_classes="textbox", lines=1,scale=3)
            #                civitAI_refresh = gr.Button(refresh_symbol, label="Refresh", elem_id="style_refresh", elem_classes="tool", lines=1)
            #                pagenumber = gr.Number(label="Page:",value=1,minimum=1,visible=False)
            #            with gr.Row():
            #                with gr.Column(elem_id="civit_cards_column"):
            #                    gr.HTML(f"""<div><div id="civitaiimages_loading"><p>Loading...</p></div><div onscroll="civitaiaCursorLoad(this)" id="civitai_cardholder" data-nopreview='{nopreview}'></div></div>""")

            with gr.TabItem(label="é£æ ¼ç”Ÿæˆå™¨",elem_id="styles_generator"):
                with gr.Row():
                    with gr.Column():
                        style_geninput_txt = gr.Textbox(label="è¾“å…¥:", lines=7,placeholder="åœ¨è¿™é‡Œè¾“å…¥åŸå§‹æ­£å‘æç¤ºè¯ã€‚ç¡®ä¿ä½ å·²ç»ä¸‹è½½ç”Ÿæˆå™¨æ‰€éœ€ä¾èµ–æ¨¡å‹åå†ç‚¹å‡»ç”ŸæˆæŒ‰é’®ï¼å…·ä½“æ“ä½œå¯æŸ¥çœ‹æ³¨æ„äº‹é¡¹ã€‚", elem_classes="stylez_promptgenbox")
                        with gr.Row():
                            style_gengrab_btn = gr.Button("è·å–æ­£å‘æç¤ºè¯",elem_id="style_promptgengrab_btn")
                    with gr.Column():
                        style_genoutput_txt = gr.Textbox(label="è¾“å‡º:", lines=7,placeholder="ç”Ÿæˆæ¶¦è‰²åçš„æ­£å‘æç¤ºè¯",elem_classes="stylez_promptgenbox")
                        with gr.Row():
                            style_gen_btn = gr.Button("ç”Ÿæˆ",elem_id="style_promptgen_btn")
                            style_gensend_btn = gr.Button("åº”ç”¨æ­£å‘æç¤ºè¯",elem_id="style_promptgen_send_btn")
                with gr.Row():
                    style_genusecomma_btn = gr.Checkbox(label="ä½¿ç”¨é€—å·", value=True)
                with gr.Row():
                    with gr.Column():
                        style_gen_temp = gr.Slider(label="æ¸©åº¦ï¼ˆè¶Šé«˜ = å¤šæ ·æ€§æ›´é«˜ä½†ä¸€è‡´æ€§è¾ƒä½ï¼‰: ", minimum=0.1, maximum=1.0 ,value=0.9)
                        style_gen_top_k = gr.Slider(label="top_kï¼ˆæ¯æ­¥é‡‡æ ·çš„å­—ç¬¦æ•°é‡ï¼‰:", minimum=1, maximum=50 ,value=8,step=1)
                    with gr.Column():
                        style_max_length = gr.Slider(label="æœ€å¤§å­—ç¬¦æ•°é‡:", minimum=1, maximum=160 ,value=80,step=1)
                        style_gen_repitition_penalty = gr.Slider(label="é‡å¤æƒ©ç½š:", minimum=0.1, maximum=2 ,value=1.2,step=0.1)

            with gr.TabItem(label="è¶…çº§æç¤ºè¯", elem_id="superprompt_generator"):
                with gr.Row():
                    with gr.Column():
                        superprompt_input_txt = gr.Textbox(label="è¾“å…¥:", lines=7, placeholder="åœ¨è¿™é‡Œè¾“å…¥åŸå§‹æç¤ºè¯ã€‚", elem_classes="superprompt_box")
                        with gr.Row():
                            superprompt_gen_btn = gr.Button("è·å–æ­£å‘æç¤ºè¯", elem_id="style_superprompt_btn")
                    with gr.Column():
                        superprompt_output_txt = gr.Textbox(label="è¾“å‡º:", lines=7, placeholder="ç”Ÿæˆæ¶¦è‰²åçš„è‡ªç„¶è¯­è¨€æç¤ºè¯", elem_classes="superprompt_box")
                        with gr.Row():
                            style_super_btn = gr.Button("ç”Ÿæˆ",elem_id="style_superprompt_btn")
                            superprompt_apply_btn = gr.Button("åº”ç”¨æ­£å‘æç¤ºè¯", elem_id="style_superprompt_send_btn")
                with gr.Row():
                    superprompt_max_length = gr.Slider(
                        label="æœ€å¤§å­—ç¬¦é‡:", 
                        minimum=1, 
                        maximum=200, 
                        value=77, 
                        step=1
                    )

            with gr.TabItem(label="é£æ ¼ç¼–è¾‘å™¨",elem_id="styles_editor"):
                with gr.Row():
                    with gr.Column():
                        style_title_txt = gr.Textbox(label="æ ‡é¢˜:", lines=1,placeholder="æ ‡é¢˜æ”¾åœ¨è¿™é‡Œï¼",elem_id="style_title_txt")
                        style_description_txt = gr.Textbox(label="æè¿°:", lines=1,placeholder="æè¿°æ”¾åœ¨è¿™é‡Œï¼", elem_id="style_description_txt")
                        style_prompt_txt = gr.Textbox(label="æ­£å‘æç¤ºè¯:", lines=2,placeholder="æ­£å‘æç¤ºè¯æ”¾åœ¨è¿™é‡Œï¼", elem_id="style_prompt_txt")
                        style_negative_txt = gr.Textbox(label="è´Ÿå‘æç¤ºè¯:", lines=2,placeholder="è´Ÿå‘æç¤ºè¯æ”¾åœ¨è¿™é‡Œï¼", elem_id="style_negative_txt")
                    with gr.Column():
                        with gr.Row():
                            style_save_btn = gr.Button(save_symbol,label="ä¿å­˜é£æ ¼", lines=1,elem_classes="tool", elem_id="style_save_btn")
                            style_clear_btn = gr.Button(clear_symbol,label="é‡æ–°ç¼–è¾‘", lines=1,elem_classes="tool" ,elem_id="style_clear_btn")
                            style_delete_btn = gr.Button(delete_style,label="åˆ é™¤é£æ ¼", lines=1,elem_classes="tool", elem_id="style_delete_btn")
                        thumbnailbox = gr.Image(value=None,label="ç¼©ç•¥å›¾ï¼ˆè¯·ä½¿ç”¨1:1å›¾ç‰‡ï¼‰:",elem_id="style_thumbnailbox",elem_classes="image",interactive=True,type='pil')
                        style_img_url_txt = gr.Text(label=None,lines=1,placeholder="Invisible textbox", elem_id="style_img_url_txt",visible=False)
                with gr.Row():
                    style_grab_current_btn = gr.Button("è·å–æç¤ºè¯",label="Grab Current", lines=1, elem_id="style_grab_current_btn")
                    style_lastgen_btn =gr.Button("è·å–æœ€æ–°ç”Ÿæˆå›¾ç‰‡",label="Save Style", lines=1,elem_id="style_lastgen_btn")
                with gr.Row():
                    with gr.Column():
                            style_filename_txt = gr.Textbox(label="æ–‡ä»¶åå‘½å:", lines=1,placeholder="æ–‡ä»¶å", elem_id="style_filename_txt")
                            style_filname_check = gr.HTML("""<p id="style_filename_check" style="color:orange;">è¯·è¾“å…¥æ–‡ä»¶åï¼ï¼ï¼</p>""",elem_id="style_filename_check_container")
                    with gr.Column():
                        with gr.Row():
                            style_savefolder_txt = gr.Dropdown(label="ä¿å­˜è‡³æ–‡ä»¶å¤¹ï¼ˆéä¸­æ–‡å‘½åï¼‰:", value="Styles", lines=1, choices=generate_styles_and_tags[2], elem_id="style_savefolder_txt", elem_classes="dropdown",allow_custom_value=True)
                            style_savefolder_temp = gr.Textbox(label="Save Folder:", lines=1, elem_id="style_savefolder_temp",visible=False)
                        style_savefolder_refrsh_btn = gr.Button(refresh_symbol, label="Refresh", lines=1,elem_classes="tool")
            
            with gr.TabItem(label="æ³¨æ„"):  # æ–°å¢çš„Tabæ ‡é¢˜
                #gr.Text(value="https://www.disambo.com", label="æ ‡é¢˜", interactive=False)  # åªè¯»æ–‡æœ¬
                gr.Markdown("""
                <p style="color: #F36812; font-size: 18px; margin-bottom: 8px;">æ³¨æ„äº‹é¡¹ï¼š</p>
                <p style="margin-bottom: 8px;"><span style="color: #F36812;">1. </span>éœ€è¦è¯´æ˜çš„æ˜¯å¦‚æœä½ ä¸å°å¿ƒä½¿ç”¨äº†<span style="color: #F36812;">WebUI</span>ç”ŸæˆæŒ‰é’®ä¸‹é¢çš„æ¸…ç©ºæç¤ºè¯ï¼Œæ­¤æ’ä»¶é£æ ¼åº“ä¸­ä½ å·²ç»é€‰æ‹©çš„é£æ ¼å¡ç‰‡æ ‡è®°å¹¶ä¸ä¼šè¢«åŒæ­¥å–æ¶ˆï¼Œä½ éœ€è¦åˆ·æ–°ä¸€ä¸‹é£æ ¼å¤§ç±»æ¸…ç©ºæ ‡è®°ã€‚</p>
                <p style="margin-bottom: 8px;"><span style="color: #F36812;">2. </span>æ­¤æ’ä»¶æç¤ºè¯å…¨éƒ¨é‡‡ç”¨æ ‡å‡†æ ¼å¼ï¼Œå¦‚æœä½ å®‰è£…äº†<span style="color: #F36812;">All in one</span>è¿™ä¸ªæ’ä»¶ï¼Œè¯·æ‰“å¼€è®¾ç½®èœå•ç‚¹å‡»ç¬¬äºŒä¸ªå›¾æ ‡è¿›è¡ŒPromptæ ¼å¼è°ƒæ•´ï¼ˆå‹¾é€‰ç¬¬äºŒé¡¹å»é™¤Promptæœ€åçš„ä¸€ä¸ªé€—å·ï¼Œå…¶ä»–é¡¹å…¨éƒ¨å–æ¶ˆå‹¾é€‰ã€‚ï¼‰</p>
                <p style="margin-bottom: 8px;"><span style="color: #F36812;">3. </span>å¦‚æœä½ æƒ³ä½¿ç”¨é£æ ¼ç”Ÿæˆå™¨å¯¹æç¤ºè¯è¿›è¡Œæ¶¦è‰²ï¼Œå¿…é¡»å…ˆä¸‹è½½è¿è¡Œä¾èµ–æ¨¡å‹<span style="color: #F36812;">distilgpt2-stable-diffusion-v2</span>ï¼ŒæŠŠæ–‡ä»¶å¤¹è§£å‹åˆ°extension/sd-webui-next-styleæ–‡ä»¶å¤¹ä¸‹ï¼Œä½ å¯ä»¥æŒ‰å‘½ä»¤è¡Œçš„æç¤ºä»<a href="https://huggingface.co/FredZhang7/distilgpt2-stable-diffusion-v2/tree/main" style="color: #F36812;">huggingface</a>ä¸‹è½½ã€‚å¦‚æœä½ ä¸ä¼šé­”æ³•ï¼Œæˆ‘è¿™é‡Œä¹Ÿæä¾›äº†ä¸€ä¸ªæ— éœ€é­”æ³•çš„åœ°å€ï¼Œè¯·ç‚¹å‡»<a href="https://daohuo-my.sharepoint.com/:u:/g/personal/ruanjian_daohuo_onmicrosoft_com/EfixWV7-fkRKtArpadqjqtsBRq7ttRVSGCVrwsMb2tUWcA?e=roW8xB" style="color: green;">ä¸‹è½½</a></p>
                <p style="margin-bottom: 8px;"><span style="color: #F36812;">4. </span>é£æ ¼ç¼–è¾‘å°æŠ€å·§ï¼šä»»ä½•åŒ…å«å…³é”®å­—<span style="color: #F36812;">{prompt}</span>çš„æç¤ºéƒ½å°†è‡ªåŠ¨è·å–ä½ å½“å‰çš„æç¤ºï¼Œå¹¶å°†å…¶æ’å…¥åˆ°<span style="color: #F36812;">{prompt}</span>çš„ä½ç½®ã€‚ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œä½ æœ‰ä¸€ä¸ªé£æ ¼çš„æç¤ºè¯æ˜¯è¿™æ ·å†™çš„<span style="color: Gray;">A dynamic, black-and-white graphic novel scene with intense action, a paiting of {prompt}</span>ï¼Œç°åœ¨ä½ åœ¨æ­£å‘æç¤ºè¯ä¸­è¾“å…¥<span style="color: Gray;">Several stray cats</span>,å½“ä½ åº”ç”¨è¿™ä¸ªé£æ ¼æ¨¡æ¿åï¼Œæ­£å‘æç¤ºè¯ä¼šå˜æˆ<span style="color: Gray;">A dynamic, black-and-white graphic novel scene with intense action, a paiting of Several stray cats</span>ã€‚æ€»ä¹‹ï¼Œå¦‚æœä½ æƒ³è‡ªå·±ç¼–è¾‘é£æ ¼æ¨¡æ¿ï¼Œå¯ä»¥å…ˆçœ‹çœ‹ç°æœ‰æ¨¡æ¿çš„æ ¼å¼ã€‚</p>
                <p style="margin-bottom: 8px;"><span style="color: #F36812;">5. </span>å¦‚æœç”¨çš„æ„‰å¿«è¯·ç‚¹å‡»ä¸‹é¢å›¾æ ‡æ”¶è—å“¦ï¼é¡ºä¾¿ä¹Ÿå¯ä»¥é€›é€›æˆ‘çš„ä¸ªäººç½‘ç«™<a href="https://www.disambo.com" style="color: green;">disambo.com</a></p>
                <a href="https://github.com/Firetheft/sd-webui-next-style" target="_blank">
                    <img src="https://bu.dusays.com/2024/03/10/65edbb64b1ece.png" alt="GitHub" style="height: 24px; width: 24px; margin-right: 8px;"/>
                </a>
                """, interactive=False)
        #civitAI_refresh.click(fn=None,_js="refreshfetchCivitai",inputs=[nsfwlvl,sortcivit,periodcivit])
        #periodcivit.change(fn=None,_js="refreshfetchCivitai",inputs=[nsfwlvl,sortcivit,periodcivit])
        #sortcivit.change(fn=None,_js="refreshfetchCivitai",inputs=[nsfwlvl,sortcivit,periodcivit])
        #nsfwlvl.change(fn=None,_js="refreshfetchCivitai",inputs=[nsfwlvl,sortcivit,periodcivit])
        style_gengrab_btn.click(fn=None,_js="stylesgrabprompt" ,outputs=[style_geninput_txt])
        style_gensend_btn.click(fn=None,_js='sendToPromtbox',inputs=[style_genoutput_txt])
        style_gen_btn.click(fn=generate_style,inputs=[style_geninput_txt,style_gen_temp,style_gen_top_k,style_max_length,style_gen_repitition_penalty,style_genusecomma_btn],outputs=[style_genoutput_txt])
        superprompt_gen_btn.click(fn=None,_js="stylesgrabprompt" ,outputs=[superprompt_input_txt])
        superprompt_apply_btn.click(fn=None,_js='sendToPromtbox',inputs=[superprompt_output_txt])
        style_super_btn.click(fn=call_generate_super_prompt,inputs=[superprompt_input_txt,superprompt_max_length],outputs=[superprompt_output_txt])
        oldstylesCB.change(fn=oldstyles,inputs=[oldstylesCB],_js="hideOldStyles")
        refresh_button.click(fn=refresh_styles,inputs=[category_dropdown], outputs=[Styles_html,category_dropdown,category_dropdown,style_savefolder_txt])
        card_size_slider.release(fn=save_card_def,inputs=[card_size_slider])
        card_size_slider.change(fn=None,inputs=[card_size_slider],_js="cardSizeChange")
        category_dropdown.change(fn=None,_js="filterSearch",inputs=[category_dropdown,Style_Search])
        Style_Search.change(fn=None,_js="filterSearch",inputs=[category_dropdown,Style_Search])
        style_img_url_txt.change(fn=img_to_thumbnail, inputs=[style_img_url_txt],outputs=[thumbnailbox])
        style_grab_current_btn.click(fn=None,_js='grabCurrentSettings')
        style_lastgen_btn.click(fn=None,_js='grabLastGeneratedimage')
        style_savefolder_refrsh_btn.click(fn=refresh_styles,inputs=[category_dropdown], outputs=[Styles_html,category_dropdown,category_dropdown,style_savefolder_txt])
        style_save_btn.click(fn=save_style, inputs=[style_title_txt, thumbnailbox, style_description_txt,style_prompt_txt, style_negative_txt, style_filename_txt, style_savefolder_temp], outputs=[style_filname_check])
        style_filename_txt.change(fn=filename_check, inputs=[style_savefolder_temp,style_filename_txt], outputs=[style_filname_check])
        style_savefolder_txt.change(fn=tempfolderbox, inputs=[style_savefolder_txt], outputs=[style_savefolder_temp])
        style_savefolder_temp.change(fn=filename_check, inputs=[style_savefolder_temp,style_filename_txt], outputs=[style_filname_check])
        style_clear_btn.click(fn=clear_style, outputs=[style_title_txt,style_img_url_txt,thumbnailbox,style_description_txt,style_prompt_txt,style_negative_txt,style_filename_txt])
        style_delete_btn.click(fn=deletestyle, inputs=[style_savefolder_temp,style_filename_txt])
        add_favourite_btn.click(fn=addToFavourite, inputs=[favourite_temp])
        remove_favourite_btn.click(fn=removeFavourite, inputs=[favourite_temp])
        stylezquicksave_add.click(fn=None,_js="addQuicksave")
        stylezquicksave_clear.click(fn=None,_js="clearquicklist")
    return [(ui, "stylez_menutab", "stylez_menutab")]

script_callbacks.on_ui_tabs(add_tab)
